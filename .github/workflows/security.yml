name: Security
on:
  push:
    branches: [main, master]
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * *" # daily

permissions:
  contents: read
  id-token: write

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  NIX_CONFIG: "extra-experimental-features = nix-command flakes"

jobs:
  secrets-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Secrets scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  scan-nixos:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        host: [rvn-vm]
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

      - uses: DeterminateSystems/nix-installer-action@v12
        with:
          extra-args: --prefer-upstream-nix
      - uses: DeterminateSystems/magic-nix-cache-action@v8
        with:
          use-flakehub: false

      - name: Build and capture store path
        id: build
        run: echo "out=$(nix build .#nixosConfigurations.${{ matrix.host }}.config.system.build.toplevel --print-out-paths)" >> "$GITHUB_OUTPUT"

      - name: Run vulnix on store path
        env:
          LANG: C.UTF-8
        run: |
          # Check if whitelist exists
          WHITELIST_ARG=""
          if [ -f ".vulnix-whitelist.toml" ]; then
            WHITELIST_ARG="--whitelist .vulnix-whitelist.toml"
          fi
          
          # Run vulnix
          nix run github:nix-community/vulnix -- --json $WHITELIST_ARG "${{ steps.build.outputs.out }}" > vulnix.json || true
          
          # Count total vulnerabilities
          total_count=$(jq 'length' vulnix.json)
          echo "Found $total_count total vulnerabilities"
          
          # Count high-severity vulnerabilities (CVSS >= 7.0)
          high_severity_count=$(jq '[ .[] | select( ([.cvssv3_basescore[]]|max) >= 7 ) ] | length' vulnix.json)
          echo "Found $high_severity_count high-severity vulnerabilities (CVSS >= 7.0)"
          
          # Count critical vulnerabilities (CVSS >= 9.0)
          critical_count=$(jq '[ .[] | select( ([.cvssv3_basescore[]]|max) >= 9 ) ] | length' vulnix.json)
          echo "Found $critical_count critical vulnerabilities (CVSS >= 9.0)"
          
          # Display summary
          echo "### 🔒 Vulnerability Summary for ${{ matrix.host }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total vulnerabilities | $total_count |" >> $GITHUB_STEP_SUMMARY
          echo "| High severity (CVSS ≥ 7.0) | $high_severity_count |" >> $GITHUB_STEP_SUMMARY
          echo "| **Critical (CVSS ≥ 9.0)** | **$critical_count** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$critical_count" != "0" ]; then
            echo "## 🚨 Critical Vulnerabilities" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            jq -r '[ .[] | select( ([.cvssv3_basescore[]]|max) >= 9 ) ] | .[] | 
              "- **\(.name)** v\(.version): \(.affected_by | join(", ")) (CVSS: \([.cvssv3_basescore[]]|max))"' \
              vulnix.json >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Actions:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Run \`nix flake update\` to get latest package versions" >> $GITHUB_STEP_SUMMARY
            echo "2. Review each CVE to verify it applies to your configuration" >> $GITHUB_STEP_SUMMARY
            echo "3. Add false positives to \`.vulnix-whitelist.toml\`" >> $GITHUB_STEP_SUMMARY
          elif [ "$high_severity_count" != "0" ]; then
            echo "## ⚠️ High Severity Vulnerabilities (Informational)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Found $high_severity_count high-severity (CVSS ≥ 7.0) vulnerabilities that don't meet the critical threshold." >> $GITHUB_STEP_SUMMARY
            echo "Review these when convenient and consider updating." >> $GITHUB_STEP_SUMMARY
          else
            echo "✅ No high-severity vulnerabilities found!" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Fail build if critical vulnerabilities found
          if ! jq '[ .[] | select( ([.cvssv3_basescore[]]|max) >= 9 ) ] | length' vulnix.json | grep -qx 0; then
            echo "::error::Found $critical_count critical vulnerabilities (CVSS >= 9.0)"
            exit 1
          fi

      - name: Analyze dependency chains
        if: always()
        run: |
          # Create dependency analysis report
          echo "# Dependency Chain Analysis for ${{ matrix.host }}" > dependency-analysis.md
          echo "" >> dependency-analysis.md
          echo "This report shows which packages depend on vulnerable packages." >> dependency-analysis.md
          echo "" >> dependency-analysis.md
          
          # Process each vulnerability
          jq -c '.[]' vulnix.json | while IFS= read -r vuln; do
            name=$(echo "$vuln" | jq -r '.name')
            version=$(echo "$vuln" | jq -r '.version')
            cves=$(echo "$vuln" | jq -r '.affected_by | join(", ")')
            cvss=$(echo "$vuln" | jq -r '[.cvssv3_basescore[]] | max')
            derivation=$(echo "$vuln" | jq -r '.derivation')
            
            echo "## $name v$version" >> dependency-analysis.md
            echo "" >> dependency-analysis.md
            echo "**CVEs:** $cves" >> dependency-analysis.md
            echo "**CVSS Score:** $cvss" >> dependency-analysis.md
            echo "**Store Path:** \`$derivation\`" >> dependency-analysis.md
            echo "" >> dependency-analysis.md
            
            # Run nix why-depends to find dependency chain
            echo "### Dependency Chain" >> dependency-analysis.md
            echo "" >> dependency-analysis.md
            echo '```' >> dependency-analysis.md
            
            if nix why-depends "${{ steps.build.outputs.out }}" "$derivation" 2>/dev/null; then
              echo "Successfully traced dependency chain"
            else
              echo "Unable to determine dependency chain (package may not be directly reachable)"
            fi >> dependency-analysis.md
            
            echo '```' >> dependency-analysis.md
            echo "" >> dependency-analysis.md
            echo "---" >> dependency-analysis.md
            echo "" >> dependency-analysis.md
          done
          
          echo "✅ Dependency analysis complete"
          
          # Add summary section
          echo "" >> dependency-analysis.md
          echo "## Summary" >> dependency-analysis.md
          echo "" >> dependency-analysis.md
          echo "Review the dependency chains above to:" >> dependency-analysis.md
          echo "1. Identify which top-level packages are pulling in vulnerable dependencies" >> dependency-analysis.md
          echo "2. Decide whether to update, replace, or remove the culprit packages" >> dependency-analysis.md
          echo "3. Check if the vulnerability actually affects your usage" >> dependency-analysis.md
          
          # Add link to summary if there are vulnerabilities
          if [ "$(jq 'length' vulnix.json)" != "0" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "📊 **[View detailed dependency analysis](dependency-analysis.md)**" >> $GITHUB_STEP_SUMMARY
          fi

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report-${{ matrix.host }}
          path: |
            vulnix.json
            dependency-analysis.md

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: vulnix-report-${{ matrix.host }}
          path: vulnix.json
