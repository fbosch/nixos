name: Security

on:
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * 1" # weekly on Monday

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}-security
  cancel-in-progress: true

jobs:
  discover-hosts:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      targets: ${{ steps.discover.outputs.targets }}
      has-targets: ${{ steps.discover.outputs.has-targets }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - uses: ./.github/actions/setup-nix
        with:
          cachix-name: fbosch
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Discover security scan targets
        id: discover
        run: |
          nixos_hosts=$(nix eval --json --apply 'x: builtins.attrNames x' .#nixosConfigurations)
          darwin_hosts=$(nix eval --json --apply 'x: builtins.attrNames x' .#darwinConfigurations 2>/dev/null || echo '[]')

          targets=$(jq -cn \
            --argjson nixos "$nixos_hosts" \
            --argjson darwin "$darwin_hosts" \
            '($nixos | map({ host: ., flake: ("nixosConfigurations." + . + ".config.system.build.toplevel") }))
             + ($darwin | map({ host: ., flake: ("darwinConfigurations." + . + ".config.system.build.toplevel") }))')

          echo "targets=$targets" >> "$GITHUB_OUTPUT"
          if [ "$targets" != "[]" ]; then
            echo "has-targets=true" >> "$GITHUB_OUTPUT"
          else
            echo "has-targets=false" >> "$GITHUB_OUTPUT"
          fi

  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: discover-hosts
    if: needs.discover-hosts.outputs.has-targets == 'true'
    strategy:
      matrix:
        include: ${{ fromJson(needs.discover-hosts.outputs.targets) }}
      fail-fast: false
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - uses: ./.github/actions/setup-nix
        with:
          cachix-name: fbosch
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Resolve system derivation
        id: resolve
        run: echo "drv=$(nix eval --raw .#${{ matrix.flake }}.drvPath)" >> "$GITHUB_OUTPUT"

      - name: Scan for vulnerabilities
        continue-on-error: true
        run: nix run github:nix-community/vulnix -- -R "${{ steps.resolve.outputs.drv }}" | tee vulnix-report.txt

      - name: Summarize security results
        if: always()
        run: |
          echo "### ðŸ”’ Security Scan: ${{ matrix.host }}" >> $GITHUB_STEP_SUMMARY
          echo '#### Vulnix' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat vulnix-report.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        if: always()
        with:
          name: security-scan-${{ matrix.host }}
          path: vulnix-report.txt
