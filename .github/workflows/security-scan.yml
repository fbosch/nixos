name: Security Scan

on:
  schedule:
    # Run daily at 3 AM UTC
    - cron: "0 3 * * *"
  workflow_dispatch:

jobs:
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v25

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Check for known vulnerabilities
        run: |
          echo "üõ°Ô∏è Checking for known vulnerabilities..."
          if command -v nix &> /dev/null && nix --version | grep -q "2.19"; then
            nix audit || echo "‚ö†Ô∏è nix audit found potential issues"
          else
            echo "‚ÑπÔ∏è nix audit not available in this Nix version"
          fi

      - name: Scan for secrets
        run: |
          echo "üîé Scanning for potential secrets..."
          if grep -r -i "password\|secret\|key\|token" --include="*.nix" . | grep -v "example\|placeholder\|dummy" | grep -v "home-manager\|nixpkgs"; then
            echo "‚ö†Ô∏è Potential secrets found in configuration files"
            exit 1
          fi

      - name: Check flake inputs for security
        run: |
          echo "üì¶ Checking flake inputs for security..."
          # Check for HTTP URLs (should be HTTPS)
          jq -r '.nodes.root.inputs | to_entries[] | .value' flake.lock | while read -r input; do
            if jq -r ".nodes.\"$input\".locked.url" flake.lock | grep -q "^http:"; then
              echo "‚ö†Ô∏è Insecure HTTP URL detected for input: $input"
              exit 1
            fi
          done
