name: Validate

on:
  push:
    branches: [main, master]
    paths-ignore:
      - "**/*.md"
      - "docs/**"
  pull_request:
    branches: [main, master]
    paths-ignore:
      - "**/*.md"
      - "docs/**"

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}-validate
  cancel-in-progress: true

env:
  NIX_CONFIG: "extra-experimental-features = nix-command flakes"

jobs:
  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - uses: ./.github/actions/setup-nix
        with:
          cachix-name: fbosch
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Lint Nix code
        run: nix run '.#lint'

      - name: Flake checks
        run: nix flake check --print-build-logs --keep-going

  discover-hosts:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: lint
    outputs:
      nixos-hosts: ${{ steps.discover.outputs.nixos-hosts }}
      darwin-hosts: ${{ steps.discover.outputs.darwin-hosts }}
      has-nixos: ${{ steps.discover.outputs.has-nixos }}
      has-darwin: ${{ steps.discover.outputs.has-darwin }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - uses: ./.github/actions/setup-nix
        with:
          cachix-name: fbosch
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Discover host matrices
        id: discover
        run: ./scripts/ci/discover-hosts.sh validate

  build-nixos:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: [lint, discover-hosts]
    if: needs.discover-hosts.outputs.has-nixos == 'true'
    strategy:
      matrix:
        host: ${{ fromJson(needs.discover-hosts.outputs.nixos-hosts) }}
      fail-fast: false
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - uses: ./.github/actions/setup-nix
        with:
          cachix-name: fbosch
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Build ${{ matrix.host }}
        run: |
          nix build ".#nixosConfigurations.${{ matrix.host }}.config.system.build.toplevel" --no-link --print-build-logs

  eval-darwin:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [lint, discover-hosts]
    if: needs.discover-hosts.outputs.has-darwin == 'true'
    strategy:
      matrix:
        host: ${{ fromJson(needs.discover-hosts.outputs.darwin-hosts) }}
      fail-fast: false
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - uses: ./.github/actions/setup-nix
        with:
          cachix-name: fbosch
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Evaluate ${{ matrix.host }}
        run: |
          nix eval ".#darwinConfigurations.${{ matrix.host }}.config.system.build.toplevel" --json > /dev/null
